name: 'RepoDynamics PyTests'
description: 'Test Python packages'
author: 'Armin Ariamajd'
branding:
  icon: file-text
  color: blue


inputs:

  repository:
    description: Full name of the repository, i.e., 'owner-username/repo-name'.
    required: false
    default: ${{ github.repository }}

  ref:
    description: Git reference to check out in the repository.
    required: false
    default: ${{ github.ref }}

  path-tests:
    description: Path to the tests directory relative to the repository root.
    required: true

  testsuite-import-name:
    description: Name of the testsuite package to import.
    required: true

  package-source:
    description: Source to install the package; either 'GitHub', 'TestPyPI', or 'PyPI'.
    required: false
    default: local

  package-name:
    description: Name of the package to install, when `package-source` is 'PyPI' or 'TestPyPI'.
    required: false
    default: ""

  package-version:
    description: |
      Version of the package to download and install, when `package-source` is 'PyPI' or 'TestPyPI'.
      If not specified, the latest version will be installed.
    required: false
    default: ""

  python-version:
    description: Python version to use.
    required: false
    default: '3.x'

  os:
    description: Current operating system of the job.
    required: false
    default: ubuntu-latest

  path-report-pytest:
    description: Path to the pytest reports directory relative to the repository root.
    required: false
    default: ""

  path-report-coverage:
    description: Path to the coverage reports directory relative to the repository root.
    required: false
    default: ""

  path-cache-pytest:
    description: Path to the pytest cache directory relative to the repository root.
    required: false
    default: ""

  path-cache-coverage:
    description: Path to the coverage cache directory relative to the repository root.
    required: false
    default: ""

  max-retries:
    description: Maximum number of retries for downloading the package from PyPI or TestPyPI.
    required: false
    default: '15'

  retry-delay:
    description: Delay between retries in seconds.
    required: false
    default: '60'


runs:
  using: "composite"
  steps:

    - name: 'Initialize'
      shell: bash
      run: |
        # Initialize
        printf "\n\n$(cat ${{github.action_path}}/logo.txt)\n\n\n"
        echo -e "\033[1;30;48;2;0;162;255m Initialize "

#    - if: ${{ inputs.package-source == 'GitHub' }}
    - uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        fetch-depth: 0
#    - if: ${{ inputs.package-source != 'GitHub' }}
#      uses: actions/checkout@v3
#      with:
#        repository: ${{ inputs.repository }}
#        ref: ${{ inputs.ref }}
#        sparse-checkout-cone-mode: false
#        sparse-checkout: |
#          ${{ inputs.path-local }}
#          ${{ inputs.path-tests }}
#          ${{ inputs.path-config }}
#          requirements.txt

    - name: 'Set up Python'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: 'Install package'
      shell: bash
      run: |
        # Setup Environment
        source $(echo "${{ github.action_path }}" | sed 's/\\/\//g')/retry.sh
        
        echo "::group::Update pip"
        python -m pip install --upgrade pip
        echo "::endgroup::"
        
        echo "::group::Install Package"
        if [ "${{inputs.package-source}}" = "GitHub" ]; then
            python -m pip install .
        
        elif [ "${{ inputs.package-source }}" = "TestPyPI" ]; then
            if [ -f "requirements.txt" ]; then
              python -m pip install -r requirements.txt
            fi

            COMMAND="python -m pip install \
              ${{ inputs.package-name }}==${{ inputs.package-version }} \
              --no-deps \
              --index-url https://test.pypi.org/simple/"
            retry_command "$COMMAND" "${{ inputs.max-retries }}" "${{ inputs.retry-delay }}"
        
        elif [ "${{inputs.package-source}}" = "PyPI" ]; then
            if [ -z "${{ inputs.package-version }}" ]; then
                COMMAND="python -m pip install ${{ inputs.package-name }}"
            else
                COMMAND="python -m pip install ${{ inputs.package-name }}==${{ inputs.package-version }}"
            fi
            retry_command "$COMMAND" "${{ inputs.max-retries }}" "${{ inputs.retry-delay }}"

        else
            echo "Invalid package-source: '${{ inputs.package-source }}'."
            exit 1
        fi
        echo "::endgroup::"
        
        echo "::group::Install Test-Suite"
        python -m pip install ./${{ inputs.path-tests }}
        echo "::endgroup::"

    - name: 'Display info'
      shell: bash
      run: |
        echo "::group::Python version"
        python -c "import sys; print(sys.version)"
        echo "::endgroup::"
        echo "::group::pip list"
        python -m pip list
        echo "::endgroup::"
        echo "::group::OS and hardware info"
        uname -a
        echo "::endgroup::"
        echo "::group::Disk space usage"
        df -h
        echo "::endgroup::"
        echo "::group::Available system resources"
        ulimit -a
        echo "::endgroup::"
        echo "::group::Root directory"
        ls -a
        echo "::endgroup::"
        echo "::group::File tree"
        find .
        echo "::endgroup::"

#    - name: 'Run dependency tests'
#      shell: bash
#      run: pipreqs ./src --debug --print

    - name: 'Load PyTest Cache'
      uses: actions/cache@v3
      with:
        path: ${{ inputs.path-cache-pytest }}
        key: >-
          pytest
          -${{ inputs.os }}
          -${{ inputs.python-version }}
#          -${{ fromJSON(inputs.config).checkout.ref_before }}

    - name: 'Load Coverage Cache'
      uses: actions/cache@v3
      with:
        path: ${{ inputs.path-cache-coverage }}
        key: >-
          coverage
          -${{ inputs.os }}
          -${{ inputs.python-version }}
#          -${{ fromJSON(inputs.config).checkout.ref_before }}

    - name: 'Run Test-Suite'
      shell: bash
      run: python -m ${{ inputs.testsuite-import-name }}

    - name: 'Upload reports'
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: Test-Suite Reports
        path: ${{ inputs.path-report-pytest }}

    - name: 'Upload coverage reports to codecov'
      if: ${{ !cancelled() && inputs.package-source == 'GitHub' }}
      # https://github.com/marketplace/actions/codecov
      # https://github.com/codecov/codecov-action
      env:
        OS: ${{ inputs.os }}
        PYTHON: ${{ inputs.python-version }}
      uses: codecov/codecov-action@v3
      with:
        directory: ${{ inputs.path-report-coverage }}
        fail_ci_if_error: false
        verbose: true
        env_vars: OS,PYTHON
